---
title: redis应用-布隆过滤器
date: 2019-12-15 22:12:17
thumbnail: /gallery/thumbnail/redis.jpg
categories:
    - 中间件
tags:
    - redis
---

## redis的布隆过滤器


1. 概念提出

布隆过滤器并不是redis的专属，它的提出和redis没有关系，是一个名叫Bloom的人在1970年的时候提出，对于海量数据我们判断一个数据是否存在于一个系统中，我们可以使用一个二进制数组（数组每一位不是 0 就是 1），然后一系列不同的随机hash方法计算数据的hash，将hash值对应的数组的值标记为1；对于这样的处理方式称为布隆过滤器；

2. 原理解析

为什么要使用二进制数组？直接保存数据也能判断是否存在，类似 set 不就行了？试想如果一个数据大小是 1K ，那么1024条数据放入set就会是1M，换成二进制数组，每个位占空间是 1bit ，然后就算是每个数据使用8种不同的hash算法，1024位需要的空间是：

1bit * 1024 * 8 / 8 = 1024b = 1k （如果计算误判率可以再除以容忍误判率）

可以看见，数据的压缩是非常明显的，这种压缩的手法，在现在的许多场景中也能见到：比如用一个数字就能表示权限，原理就是将数字转换位二进制，每一个二进制数据都是一个权限，0 为开通 1为 非开通。
那么我们查看数据是否存在的时候通过布隆过滤器就再次按照原先的那一系列的hash算法，如果计算出的所有的位置上的数都是1，那么数据就存在；

3. 了解缺陷

误判（布隆过滤器说不存在的数据一定不存在，说存在的元素不一定存在）
既然是hash算法，就由随机性，每个数据算出的hash是随机的，那么就可能计算出的hash重复的情况，这样的话就可能出现误判的情况。假设这么几个数据：
``` bash
数据        hash
zhangsan    1,2,3,4,5,6,7,8;
lisi        9,10,11,12,13,14,15,16;
wangwu      2,4,6,8,10,12,14,16;
```
如果数据 "zhangsan" 和 "lisi" 存在，但是 "wangwu" 不存在，但是在判断的时候，hash计算出来判断这时 "wangwu" 是存在的，这就是误判，存储的数据越多，是1的数据位就越多，误判的可能性就越大，这个时候可以扩充过滤器来减小误判率；

维护（增加，删除等如何操作）
使用布隆过滤器的时候，我们需要向其中添加数据，不论是动态还是静态的添加总之我们是要维护的，这增加了我们的工作量。其次，如果想要将添加的数据移除，这是不可能的，因为可能这个数据计算的hash会影响到其他的数据，所以不能随意的删除；

4. 使用场景

总结了布隆过滤器的原理和优劣，那么哪些地方可以使用到他呢？
海量数据的检测：黑名单检测，缓存穿透处理，关键字命中，url去重，用户活跃统计等；
为什么是海量， 数据量不大，压缩数据和维护的成本来说不划算；

5. java中使用

最简单的使用方式，使用，可以使用redis命令setbit，结合springboot使用：

``` java

// 设置值的时候:
/**
 * @Param key : 过滤器的名字
 * @Param offset: 过滤器下标偏移量
 * @Param value : true/false 设置 1 / 0
 */
redistemplate.opsForValue().setBit(key, offset, value);

// 检验判断
redistemplate.opsForValue().getBit(key, offset);
```

这是java中操作redis中bit的操作，而hash算法，循环设置值等操作，可以自行封装；


